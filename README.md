# tezos-k8s

helper program to deploy tezos on kubernetes

## quickstart

``` shell
python3 -m venv .venv
source .venv/bin/activate
pip install -e ./
```

## private chain

### Generate constants

Your chain is uniquely defined by a set of values such as bootstrap account keys, chain id, timestamp...

Create these values:

``` shell
mkchain generate-constants $CHAIN_NAME
```

It will create two 2 yaml files, `<$CHAIN_NAME>_chain.yaml` and `<$CHAIN_NAME>_chain_invite.yaml`.

#### Chain parameters

You can modify these parameters by:

* passing parameters to the `generate-constants` subcommand
* modifying the yaml file generated by `generate-constants`
* passing argument to `mkchain create` and `mkchain invite` commands, which will selectively override the yaml parameters

| YAML Parameter | mkchain argument | Description | Default |
| ----- | ----------- | ------ | ----- |
| additional_nodes | --additional-nodes |  Number of peers in the cluster excluding the bootstrap node | 0 |
| baker | --baker | Include a baking node in the cluster | True |
| docker_image | --docker-image | Version of the Tezos docker image | tezos/tezos:v7-release |
| bootstrap_mutez | --bootstrap-mutez | Initial balance of the bootstrap accounts | 4000000000000 |
| zerotier_network | --zerotier-network | Zerotier network id for external chain access | |
| zerotier_token | --zerotier-token | Zerotier token for external chain access | |
| bootstrap_peer | --bootstrap-peer | peer ip to join | |
| genesis_key | --genesis-key | genesis public key for the chain to join | |
| genesis_block | --genesis-block | hash of the genesis block | |
| timestamp | --timestamp | timestamp for the chain to join | |
| protocol_hash | --protocol-hash | Desired Tezos protocol hash | PsCARTHAGazKbHtnKfLzQg3kms52kSRpgnDY982a9oYsSXRLQEb |
| baker_command | --baker-command | The baker command to use, including protocol | tezos-baker-006-PsCARTHA |

### create
$CHAIN_NAME: is your private chain's name

``` shell
mkchain create $CHAIN_NAME | kubectl apply -f -
```

### invite
$CHAIN_NAME: is your private chain's name
$IP is the ip address your node will serve rpc on.

Output is suitable to copy/paste and share with joiners.

``` shell
IP=$(kubectl -n tqtezos exec  daemonsets/zerotier-bridge -- zerotier-cli get $ZT_NET ip)
mkchain invite --bootstrap-peer $IP $CHAIN_NAME > join-$CHAIN_NAME.yaml
```

### join
You will typically receive a yaml file from a private chain creator.

## Development

The main specification of the kubernetes deployments are written in 
[Dhall](https://dhall-lang.org/), a programmable and safe configuration language 
with functions and types. While no Dhall installation is required to run 
`mkchain`, having `dhall` and `dhall-to-yaml` on your system is useful during 
development due to better error messages and linting/normalization features.

To type check the main mkchain configuration and get useful error messages, simply run:

```sh
$ dhall --explain <<< ./tqchain/dhall/mkchain.dhall
```

You can also type and error-check each individual dhall file too, e.g.

```sh
$ dhall --explain <<< ./tqchain/dhall/tezos/makeNode.dhall
```

Dhall prints out normalized versions of any config file (removes all 
abstractions). While the normalized versions of kubernetes configs will be full 
of nil Optional fields, it's still a good exercise for debugging:

```sh
$ dhall <<< ./tqchain/dhall/tezos/makeNode.dhall > normalizedMakeNode.dhall
$ cat normalizedMakeNode.dhall
λ ( opts
  : { additional_nodes : Natural
    , baker : Bool
    , baker_command : Text
    , bootstrap_accounts : Text
    , bootstrap_mutez : Natural
    , bootstrap_peer : Text
    , bootstrap_timestamp : Text
    , chain_name : Text
    , docker_image : Text
    , genesis_chain_id : Text
    , keys : List { mapKey : Text, mapValue : Text }
    , protocol_hash : Text
    , zerotier_data : List { mapKey : Text, mapValue : Text }
    , zerotier_enabled : Bool
    }
  ) →
  { apiVersion = "apps/v1"
  , kind = "StatefulSet"
  , metadata =
    { annotations = None (List { mapKey : Text, mapValue : Text })
    , clusterName = None Text
    ...
    }
  ...
  }
```

## EKS
https://aws.amazon.com/premiumsupport/knowledge-center/eks-persistent-storage/

