# Permissioned Chain

This tutorial will walk you through setting up a Tezos based
permissioned blockchain. Upon successful completion of this tutorial
you will have a permissioned chain running with three nodes in a
peer-to-peer network. This tutorial assumes the use of Minikube on
MacOS.


## Prerequisites

* docker
* minikube
* python3
* a ZeroTier network and api access token
* jq
* Optional: [dhall-yaml](https://github.com/dhall-lang/dhall-lang/)

## Installing prerequisites 

This section varies depending on OS.

### Mac w/ homebrew

Make sure homebrew is installed:

``` shell
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)"
```

Install prerequisites:

``` shell
brew install python3
brew install jq
brew install minikube
brew install dhall-yaml
```

### Arch Linux 

```shell
pacman -Syu && pacman -S python3 jq minikube kubectl kubectx linux dhall-yaml
```

## Setting up mkchain

Ensure minikube is running:

``` shell
minikube start
```

Install the mkchain program:

``` shell
python3 -m venv .venv-tezos-k8s
source .venv-tezos-k8s/bin/activate
pip install https://github.com/tqtezos/tezos-k8s/archive/master.zip
```

Create a ZeroTier network:

* Go to https://my.zerotier.com
* Login with google credentials or create a new account
* Create a new API access token by clicking on the "Generate New
Token" button. Save the generated access token. e.g. "yEflQt726fjXuSUyQ73WqXvAFoijXkLt"
* Go to https://my.zerotier.com/network
* Create a new network by clicking on the "Create a Network"
button. Save the 16 character generated network
id. e.g. "1c33c1ced02a5eee"

Set environment variables so we can access these values with later commands:
``` shell
ZT_TOKEN=yEflQt726fjXuSUyQ73WqXvAFoijXkLt
ZT_NET=1c33c1ced02a5eee
```

Give your private chain a name:

``` shell
CHAIN_NAME=my_chain
```

Set unbuffered IO for python:

``` shell
PYTHONUNBUFFERED=x
```

Run the following command to create the chain yaml:

``` shell
mkchain generate-constants --zerotier-network $ZT_NET \
--zerotier-token $ZT_TOKEN $CHAIN_NAME
mkchain create $CHAIN_NAME > output.yaml
```

Feed the chain yaml file to kubernetes:

``` shell
kubectl apply -f output.yaml
```

Your kubernetes cluster will now be running a series of jobs to
perform the following tasks:

* generate a node identity
* generate a genesis block for your chain
* activate the protocol
* bake the first block
* start the bootstrap-node node and a baker to validate the chain

You can find your node in the tqtezos namespace using kubectl.

``` shell
kubectl -n tqtezos get pods
```

You can view logs for your node using the following command:
``` shell
kubectl -n tqtezos logs -l app=tezos-bootstrap-node -c tezos-node -f
```

Congratulations! You now have an operational Tezos based permissioned
chain running one node.

## Add nodes within the cluster

You can configure a self-contained testnet within your cluster with
a number of nodes of your choice by passing the following argument to
mkchain generate-constants:

```
mkchain generate-constants --additional-nodes 2 <...> $CHAIN_NAME
```

The nodes will establish peer-to-peer connections in a full mesh topology.

If you previously spun up the chain with just one node, you may scale
up your setup to an arbitrary number of nodes by overriding the 
--additional-nodes
parameter in the `create` command:

```
# create
mkchain create $CHAIN_NAME | kubectl apply -f -
# scale up
mkchain create --additional-nodes 2 $CHAIN_NAME | kubectl apply -f -
```

## Add external nodes to the cluster

Additional nodes can be added to your network by sharing a yaml file
generated by the mkchain invite command.

For this to work, you need to pass a valid zerotier network and token parameter in the previous steps.

### create the invitation

``` shell
IP=$(kubectl -n tqtezos exec  daemonsets/zerotier-bridge -- zerotier-cli get $ZT_NET ip)
mkchain invite --bootstrap-peer $IP $CHAIN_NAME > join-$CHAIN_NAME.yaml
```

Share the resulting join-$CHAIN_NAME.yaml with your partner via a
secure channel.


### on the computer of the joining node

The member can apply the shared yaml to their Minikube cluster:

``` shell
kubectl apply -f join-$CHAIN_NAME.yaml
```

At this point additional nodes will be added in a star network
topology. In order to get nodes communicating via p2p one of the nodes
must be told about the VPN addresses used by the clients.

The following command can be used to force a peering connection over
the VPN network.

``` shell
curl -H "Authorization: bearer $ZT_TOKEN" \
https://my.zerotier.com/api/network/$ZT_NET/member|jq -r ".[].config.ipAssignments[0]" | while read i
do
    kubectl -n tqtezos exec deployment/tezos-node -- /usr/local/bin/tezos-admin-client connect address $i:30732
done
```

Congratulations! You now have a multi-node Tezos based permissioned
chain.

Check that the nodes have matching heads by comparing their hashes:

``` shell
kubectl -n tqtezos exec deployment/tezos-node -c tezos-node -- /usr/local/bin/tezos-client rpc get /chains/main/blocks/head/hash
```
